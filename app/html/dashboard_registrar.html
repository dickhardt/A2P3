<!DOCTYPE html>
<html>
<head>
<style type="text/css">
  .loginStatus {text-align:right;}
  .registerAppForm{border:1px solid #999; -webkit-box-shadow: 0px 0px 6px #CCC; background-color:#FFF; width:250px; height:250px; position: absolute; top:75px; left:50%; margin-left:-125px; padding:10px; border-radius:4px;}
  .appDetailPopup{border:1px solid #999; -webkit-box-shadow: 0px 0px 6px #CCC; background-color:#FFF; width:320px; height:350px; position: absolute; top:75px; left:5%; margin-left:-20px; padding:10px; border-radius:4px;}
  .confirmDeleteForm{border:1px solid #999; -webkit-box-shadow: 0px 0px 6px #CCC; background-color:#FFF; width:300px; height:120px; position: absolute; top:100px; left:10%; margin-left:-20px; padding:10px; border-radius:4px;}
  .addAppAdminForm{border:1px solid #999; -webkit-box-shadow: 0px 0px 6px #CCC; background-color:#FFF; width:300px; height:120px; position: absolute; top:100px; left:10%; margin-left:-20px; padding:10px; border-radius:4px;}

</style>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1,user-scalable=no">
	<link rel="stylesheet" href="/css/style.css">
</head>
<body>

  <script type="text/javascript"    src="/js/jquery-1.8.3.js"></script>
  <script type="text/javascript"    src="/js/purl.js"></script>
  <script type="text/javascript" src="/js/common.js"></script>

<header class="header">
	<section class="headerContainer">
		<span class="mainTitle" id='title'>XX Dashboard</span>
		<div class="mainTitleText"></div>
	</section>
</header>
<section class="mainContent">
	<div class="mainContentWrap">
		<h2>Welcome <span id="loginEmail"></span></h2>
		<br>
		<a class="genericButton" href="" id="login"> login </a>
		<a class="genericButton" href="/logout" id="logout">logout </a>
		<a class="genericButton" href="" id="registerApp">Register Application</a>
		<br><br>
		<div class="appsTableWrapper">
			<table class="appsTable" id='appTable'>
			</table>
		</div>

		<div id="registerApp_form" class="registerAppForm">
		  <div class="genericTitle">Register a new App</div>
		    <form id="registerAppForm_input">
		      <dl>
            <dt></dt><dd>
              <label class="genericLabel" for="AppName" style="text-align: left;">Name</label>
              <input type="text" name="AppName" value="" id="registerApp_name_input">
              <br><br>
            </dd>
		        <dt></dt><dd>
		          <label class="genericLabel" for="ApID" style="text-align: left;">ID</label>
		          <input type="text" name="AppID" value="" id="registerApp_id_input">
		        </dd>
            <dt></dt><dd>
              <p class="label_checkbox_pair">
              	<label for="AppAnytime">Anytime Resource</label>
              <input type="checkbox" name="AppAnytime" value="" id="registerApp_anytime_input">
              </p>
              <br><br>
            </dd>
		        <dt></dt><dd>
		        <label id="registerApp_status"><i>ID is hostname</i></label>
		      </dd>
		      </dl>
		        <p>
		          <input class="genericButton" id="registerAppFormCancel" type="button" value="Cancel">
		          <input class="genericButton" id="registerAppFormSubmit" type="button" value="Register">
		        </p>
		    </form>
		</div>
		<div id="appDetails_popup" class="appDetailPopup">
		  <div class="genericTitle" id="appDetailsTitle" >App Details</div>
		    <table id="adminsList">
		        <tr><td class="genericLabel" width="50px">Name:</td><td id="appDetails_Name"></td></tr>
		        <tr><td class="genericLabel">ID:</td><td id="appDetails_ID"></td></tr>
		        <tr><td class="genericLabel">Key:</td><td><textarea id="appKey"rows="3" style="width: 225px;" readonly="readonly"></textarea></td></tr>
            <tr><td class="genericLabel"></td><td>
            	<p class="label_checkbox_pair">
            	<input type="checkbox" name="AppAnytime" value="" id="appDetails_Anytime" disabled="true">
            	<label for="appDetails_Anytime">Anytime Resource</label></p>
			</td></tr>

		        <tr><td class="genericLabel">Key ID:</td><td id="appKID"></td></tr>
		        <tr><td class="genericLabel">Admins:</td><td><a class="otherLinks" href="" id="addAppAdmin">add</a></td></tr>
		        <div id="appAdminDetailsTable">
		        </div>
		    </table>
		    <p>
		      <input class="genericSmallButton" id="appDetailsDelete" type="button" value="Delete">
		      <a class="genericSmallButton" href="" id="refreshAppKey">Renew Key</a>
		      <input class="genericSmallButton" id="appDetailsClose" type="button" value="Close">
		    </p>
		</div>

		<div id="confirmDelete_form" class="confirmDeleteForm">
		  <div class="genericTitle" id="confirmDeleteTitle">Confirm Deletion XX</div>
		    <form id="confirmDeleteForm_input">
		      <p>
		        <input class="genericSmallButton" id="confirmDeleteFormCancel" type="button" value="Cancel">
		        <input class="genericSmallButton" id="confirmDeleteFormDelete" type="button" value="Delete">
		      </p>
		    </form>
		</div>

		<div id="confirmAdminDelete_form" class="confirmDeleteForm">
		  <div class="genericTitle" id="confirmAdminDeleteTitle">Confirm Deletion XX</div>
		    <form id="confirmAdminDeleteForm_input">

		        <input class="genericSmallButton" id="confirmAdminDeleteFormCancel" type="button" value="Cancel">
		        <input class="genericSmallButton" id="confirmAdminDeleteFormDelete" type="button" value="Delete">

		    </form>
		</div>

		<div id="addAppAdmin_form" class="addAppAdminForm">
		  <div class="genericTitle" id="addAppAdminTitle">Add App Administrator</div>
		    <form id="addAppAdminForm_input">
		       <dl>
		        <dt></dt><dd>
		          <label class="genericLabel" for="adminEmail" style="text-align: left;">Email</label>
		          <input type="text" name="adminEmail" value="" id="adminEmail_input">
		        </dd>
		        </dl>
		      <p>
		        <input class="genericSmallButton" id="addAppAdminFormCancel" type="button" value="Cancel">
		        <input class="genericSmallButton" id="addAppAdminFormAdd" type="button" value="Add">
		      </p>
		    </form>
		</div>
	</div>
</section>

<script type="text/javascript">

/*
*   TODO: 'esc' and 'return' are not doing what is expected in most of the forms, need to capture and do right thing
*/

  (function() { // wrapper

    var currentApp = null
    var currentAdmin = null

    ///////////////////////////////////////////////////////////////////////////
    // setup initial states

    $('#confirmDelete_form').hide()
    $('#confirmAdminDelete_form').hide()
    $('#appDetails_popup').hide()
    $('#addAppAdmin_form').hide()


    $('#refreshAppKey').click( function () {
      app = currentApp
      $('#appKID').fadeOut('fast')
      $('#appKey').fadeOut('fast')
      $.post('/dashboard/refresh/key', { id: app }, function ( data, status ) {
        if (status == "success" && !data.error) {
          $('#appKID').text( data.result.key.latest.kid )
          $('#appKey').val( data.result.key.latest.key )
          $('#appKID').fadeIn('fast')
          $('#appKey').fadeIn('fast')
        } // TBD -- what do we show on error????
      })
      return false
    })

    /////////////////////////////////////////////////////////////////////////
    // App Detail Popup

    $('#appDetailsClose').click( function () {
      $('#appDetails_popup').fadeOut('fast')
    })

    $('#confirmDeleteFormCancel').click( function () {
      $('#confirmDelete_form').fadeOut('fast')
    })


    $('#confirmAdminDeleteFormCancel').click( function () {
      $('#confirmAdminDelete_form').fadeOut('fast')
    })

    $('#addAppAdminFormCancel').click( function () {
      $('#addAppAdmin_form').fadeOut('fast')
    })

    $('#addAppAdminFormAdd').click( function (e) {
      var app = currentApp
      var admin = $('#adminEmail_input').val()
      $.post('/dashboard/add/admin', { id: app, admin: admin }, function ( data, statis ) {
        $('#addAppAdmin_form').fadeOut('fast')
        showAppDetails( app )
      })
      return false
    })

    $('#addAppAdmin').click( function () {
      $('#addAppAdmin_form').fadeIn('fast')
      $('#adminEmail_input').focus()
      $('#adminEmail_input').val('')
      $('#addAppAdminFormAdd').attr('disabled', 'disabled')
      return false
    })

    $('#adminEmail_input').bind('input', function () {
      if ( $('#adminEmail_input').val() ) {
        $('#addAppAdminFormAdd').removeAttr('disabled')
      } else {
        $('#addAppAdminFormAdd').attr('disabled', 'disabled')
      }
    })

    $('#confirmDeleteFormDelete').click( function() {
      var app = currentApp
      $.post('/dashboard/delete/app', { id: app }, function ( data, status ) {
        $('#confirmDelete_form').fadeOut('fast')
        $('#appDetails_popup').fadeOut('fast')
        updateDashboardTable()
      })
      return false
    })

    $('#appDetailsDelete').click( function () {
      app = currentApp
      $('#confirmDelete_form').fadeIn('fast')
      $('#confirmDeleteTitle').text('Delete registration of "'+app+'"?')
      return false
    })

    $('#confirmAdminDeleteFormDelete').click( function() {
      app = currentApp
      admin = currentAdmin
      $.post('/dashboard/delete/admin', { id: app, admin: admin }, function ( data, status ) {
        $('#confirmAdminDelete_form').fadeOut('fast')
        showAppDetails( app )
      })
      return false
    })

    function deleteAppAdmin( admin ) {
      app = currentApp
      currentAdmin = admin
      $('#confirmAdminDelete_form').fadeIn('fast')
      $('#confirmAdminDeleteTitle').text('Remove admin "'+admin+'" from "'+app+'"?')
      return false
    }


    function showAppDetails ( app, fadeIn ) {
      currentApp = app

      if ( fadeIn ) $('#appDetails_popup').fadeIn('fast')
      $.post('/dashboard/app/details', {id: app}, function ( data, status ) {
        if (status == "success" && !data.error) {
          var details = data.result.details
          var currentAdmin = data.result.email
          $('#appDetails_Name').text( details.name )
          $('#appDetails_Anytime').prop('checked', details.anytime )
          $('#appDetails_ID').text( app )
          $('#appKey').val( details.keys.latest.key )

          // TBD - will need to make Key line wrap so that it is on multiple lines, but can be selected easily as a single
          // text string for developers to copy and paste into code

          $('#appKID').text( details.keys.latest.kid )

          var item = 0 // use for ids for delete links
          $('.adminEntry').remove()
          $.each( details.admins, function ( admin ) {
            // filter out adding delete if current user is the Admin TBD
            if (currentAdmin === admin) {
              $('#adminsList').append('<tr class="adminEntry"><td></td><td>'+admin+'</td></tr>')
            } else {
              $('#adminsList').append('<tr class="adminEntry"><td><a href="" id="deleteAppAdmin_'+item+'">delete</a></td><td>'+admin+'</td></tr>')
            }
            $('#deleteAppAdmin_'+item).click( function () { return deleteAppAdmin( admin ) } ) //dynamic built element, so ok to hook with closure
          })

          // TBD -- adjust the popup height so appropriate for number of admins listed
        }
      })
      return false
    }


    /////////////////////////////////////////////////////////////////////////////////////////////
    // Dashboard refresh
    function updateDashboardTable () {
      $.post('/dashboard/list/apps', function ( data, status ) {
        if (status == "success" && !data.error) {
          $('#appTable').empty()
          var list = data.result.list
          var html = null
          var item = 0  // use a counter since the app has '.'s which browser is cranky about in element IDs
          $('#appTable').append( "<thead><th style='width: 30%; text-align:left;'>Name</th><th style='width: 30%; text-align:left;'>Id</th></thead>" )
          $.each( list, function ( app ) {
            html = '<tr><td><a class="otherLinks" href="" id="' + item +'_details">' + list[app].name +'</a>' +
              '</td><td>' + app + '</td></tr>'
            $('#appTable').append( html )
            $('#'+item+'_details').click( function () { return showAppDetails( app, true ); } )
            item++
          })
        }
      })
    }

    ////////////////////////////////////////////////////////////////////////////////////////////
    // Register App form

    $('#registerApp_form').hide()

    $('#registerApp').click( function () {
      $('#registerApp_form').fadeIn('fast')
      $('#registerApp_id_input').val('')
      $('#registerApp_name_input').val('')
      $('#registerApp_name_input').focus()
      $('#appDetails_Anytime').prop('checked', false )
      $('#registerAppFormSubmit').attr('disabled', 'disabled')
      $('#registerApp_id_input').removeAttr('disabled')
      $('#registerApp_name_input').removeAttr('disabled')
      $('#registerAppFormSubmit').show()
      $('#registerAppFormCancel').show()
      $('#registerApp_status').text('').css('color','black')
      return false
    })

    $('#registerApp_id_input').bind('input', function () {
      var host = $('#registerApp_id_input').val()
      if (!host) {
        $('#registerApp_status').text('Enter a valid hostname').css('color','black')
        $('#registerAppFormSubmit').attr('disabled', 'disabled')

      } else if // valid hostname
          ( host.match( /^(([a-zA-Z]|[a-zA-Z][a-zA-Z0-9\-]*[a-zA-Z0-9])\.)*([A-Za-z]|[A-Za-z][A-Za-z0-9\-]*[A-Za-z0-9])$/ ) ) {
        $('#registerApp_status').text('Hostname is valid').css('color','black')
        $('#registerAppFormSubmit').removeAttr('disabled')

      } else {
        $('#registerApp_status').text('Hostname is invalid').css('color','red')
        $('#registerAppFormSubmit').attr('disabled', 'disabled')
      }

    })

    $('#registerAppFormSubmit').click( function () {
      $('#registerApp_id_input').attr('disabled', 'disabled')
      $('#registerApp_name_input').attr('disabled', 'disabled')
      var id = $('#registerApp_id_input').val()
      var name = $('#registerApp_name_input').val()
      var anytime = $('#registerApp_anytime_input').prop('checked')
      $('#registerApp_status').text('Registering App "'+id+'"" ... ').css('color','black')
      $('#registerAppFormSubmit').hide()
      $('#registerAppFormCancel').hide()
      $.post('/dashboard/new/app', { name: name, id: id, anytime: anytime}, function ( data, status ) {
        updateDashboardTable()
        if (status == "success" && !data.error) {
          $('#registerApp_form').fadeOut('fast')
          showAppDetails( id, true )  // show user their new app
        }
      })
    })


    $('#registerAppFormCancel').click( function () {
      $('#registerApp_form').fadeOut('fast')
    })

    ///////////////////////////////////////////////////////////////////////////////////
    // Init code

    function onReady() {

      // Write title and pull in image based on host we are at
      // URL is parsed in config.js and made available
      var title = config.subhost.charAt(0).toUpperCase() + config.subhost.substr( 1 )
      if (title === 'Si') title = 'Social Insurance'
      if ( config.province ) title += ' '+ config.provinceNames[config.province]
      title += ' Resource Server Dashboard'
      $('#title').text( title )
      var flag = config.province || 'ca'
      $('#title').before('<img class="flagImage" src="/images/flags/' + flag + '.png">')

      // called when tokens are about to expire
      function logout() {
        window.location = '/logout'
      }

      // check if we are logged in, if so, then show email and enable logout
      $.post('/login/check', function ( data, status ) {
        if (data && data.result && data.result.user) {
          if (data.result.expiresIn) {
            window.setTimeout( logout, data.result.expiresIn*1000)
          }
          $('#loginEmail').text(data.result.user)
          $('#logout').show()
          $('#login').hide()
        } else {
          $('#logout').hide()
          $('#login').show()
        }
      })

      // get registered apps and insert into Dashboard table
      updateDashboardTable()

    } // onReady

  $(document).ready( onReady )

  })(); // end wrapper
</script>

</body>
</html>