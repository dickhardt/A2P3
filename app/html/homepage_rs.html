<!DOCTYPE html>
<html>
<head>
	<style type="text/css">
	  .loginStatus {text-align:center;}
	  #qrcodeForm{border:1px solid #999; -webkit-box-shadow: 0px 0px 6px #CCC; background-color:#FFF; width:400px; height:420px; position: absolute; top:75px; left:10%; margin-left:-50px; padding:10px; border-radius:4px; z-index: 1;}
	</style>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1,user-scalable=no">
	<link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <script type="text/javascript"    src="/js/jquery-1.8.3.js"></script>
  <script type="text/javascript"    src="/js/purl.js"></script>
  <script type="text/javascript"    src="/js/jquery.qrcode.min.js"></script>
  <script type="text/javascript"    src="/js/config.js"></script>

<header class="header">
	<section class="headerContainer">
		<span class="mainTitle" id='title'>XX Resource Server</span>
		<div class="mainTitleText"></div>
	</section>
</header>
<section class="mainContent">
	<div class="mainContentWrap">
		<h2>Welcome <span id="loginEmail"></span></h2>
		<br>
		
		<a href="" id="login" class="genericButton"> login </a>
		<a href="/logout" id="logout" class="genericButton">logout </a>
		<div id="qrcodeForm">
		    <span class="form_title">Scan QR Code to login</span>
		    <div id="qrcode"></div>
		</div>
		<a class="genericButton" href="/documentation">Documentation</a>
		<br>
		<br>
	</div>
</section>
<section class="footerContent">
	<div class="loginStatus" id="backdoor">
	  * Backdoor *
	  <a href="" id="loginBackdoor" class="backdoorLinks"> Login </a>
	  * Backdoor *
	</div>
</section>

<script type="text/javascript">

function onReady() {

  // check if are running on iOS or android, only agent platforms currently supported
  var deviceAgent = navigator.userAgent.toLowerCase()
  var iOS = deviceAgent.match(/(iphone|ipod|ipad)/)
  var isAndroid = deviceAgent.indexOf("android") > -1
  var agentDirect = iOS || isAndroid
  var setupURL = config.protocol + '://setup.' + config.baseDomain + ':' + config.port + '/backdoor'
  $('#loginBackdoor').attr('href', setupURL )

  // Write title and pull in image based on host we are at
  // URL is parsed in config.js and made available
  var title = config.subhost.charAt(0).toUpperCase() + config.subhost.substr( 1 )
  if (title === 'Si') title = 'Social Insurance'
  if ( config.province ) title += ' '+ config.provinceNames[config.province]
  title += ' Resource Server'
  $('#title').text( title )
  var flag = config.province || 'ca'
  $('#title').before('<img class="flagImage" src="/images/flags/' + flag + '.png">')

  // check if we are logged in, if so, then show email and enable logout
  $.get('/login/check', function ( data, status ) {
    if (data && data.result && data.result.user) {
      $('#loginEmail').text(data.result.user)
      $('#logout').show()
      $('#login').hide()
      $('#loginBackdoor').hide()
    } else {
      $('#logout').hide()
      $('#login').show()
      $('#loginBackdoor').show()
    }
  })

  $('#qrcodeForm').hide()

    // function that polls to see if we are logged in yet
  function checkQR ( qrSession ) {
    $.post( '/check/QR', { qrSession: qrSession }, function ( data, status ) {
      if ( status == 'success' && data) {
        if ( data.status == 'waiting')
          return setTimeout( checkQR, 500, qrSession )
        // if (data.error) console.log( data.error )
        if (data.result) {
          window.location = '/dashboard'
        }
      }
    })
  }

  $('#login').click( function () {
    if (agentDirect) {
      window.location = '/login'
    } else {  // put up QR code
      // $.ajaxSetup(
      //   { type: 'POST'
      //   , headers: { "cache-control": "no-cache" }
      //   } )
      $.get( '/login/QR', function ( data, status ) {

        console.log( data, status )

        if (status == "success" && !data.error && data.result && data.result.qrURL && data.result.qrSession ) {
          $('#qrcode').empty()
          $('#qrcodeForm').fadeIn('fast')
          $('#qrcode').qrcode( {width: 400, height: 400, text: data.result.qrURL } )
          setTimeout( checkQR, 500, data.result.qrSession )
        }
      })
    }
    return false
  })




} // onReady

$(document).ready(onReady)

</script>

</body>
</html>