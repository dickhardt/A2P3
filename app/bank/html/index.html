<!DOCTYPE html>
<html>
<head>
<style type="text/css">
  .loginStatus {text-align:center;}
  .di {text-align:right;}
  .loginItem {padding-left: 5px;}
  #qrcodeForm{border:1px solid #999; -webkit-box-shadow: 0px 0px 6px #CCC; background-color:#FFF; width:400px; height:450px; position: absolute; top:25px; left:10%; margin-left:-50px; padding:10px; border-radius:4px;}
</style>

</head>
<body>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
  <script type="text/javascript"    src="/js/purl.js"></script>
  <script type="text/javascript"    src="/js/config.js"></script>
  <script type="text/javascript"    src="/js/jquery.qrcode.min.js"></script>

<div id="qrcodeForm">
    <p>Scan QR Code with your Agent to login</p>
    <div id="qrcode"></div>
</div>


<H1 id='title'>Bank</H1>

<div id="error">
  <span id="errorMessage"></span>
</div>

<div class="di">
  <div id="directedIdentifier"></div>
  <a href="" id="showDI">show DI</a>
  <a href="" id="hideDI">hide DI</a>
</div>

<div id="introduction">
  <h2> Welcome to the Bank App </h2>
  <p>This is an <a href="http://www.a2p3.net/">A2P3</a> demonstration site.</p>
  <ul>
    <li>Openning an account will prompt for the release of data, accept TOS and create an account.
    </li>
    <li>Login will authenticate the user, check if they have an account, and the SIN will be acquired with an anytime OAuth token.
    </li>
    <li>If the remember me box is checked during login while scanning a QR code, a button to login as that user will appear next time.</li>
  </ul>
</div>

<hr>

<div class="loginStatus">
  <a href="" id="newAccount" class="loginItem"> Open an Account </a>
  <a href="" id="login" class="loginItem"> login </a>
  <a href="/logout" id="logout" class="loginItem">LOGOUT</a>
  <a href="/logout" id="cancel" class="loginItem">CANCEL</a>
  <a href="/close" id="closeAccount" class="loginItem">CLOSE ACCOUNT</a>
</div>

<hr>
<div class="loginStatus" id="backdoor">
  ** Backdoor **
  <a href="/new/backdoor" id="newAccountBackdoor" class="loginItem"> Open an Account </a>
  <a href="/login/backdoor" id="loginBackdoor" class="loginItem"> login </a>
  ** Backdoor **
</div>

<table id="profileTable"> </table>


<div id="TOS">

<p>Terms of Service</p>
<!-- make the a scrollable text box -->
<p>
  Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
</p>
<a href="" id="agreeTOS">I agree</a>
</div>


<script type="text/javascript">

function onReady() {

  // check if are running on iOS or android, only agent platforms currently supported
  var deviceAgent = navigator.userAgent.toLowerCase()
  var iOS = deviceAgent.match(/(iphone|ipod|ipad)/)
  var isAndroid = deviceAgent.indexOf("android") > -1
  var agentDirect = iOS || isAndroid
  var PEOPLE_RS = 'people.' + config.baseDomain
  var SI_RS = 'si.'+ config.baseDomain
  var IX_ID = 'ix.'+ config.baseDomain

  $('#qrcodeForm').hide()
  $('#logout').hide()
  $('#error').hide()
  $('#cancel').hide()
  $('#closeAccount').hide()
  $('#TOS').hide()
  $('#hideDI').hide()
  $('#directedIdentifier').hide()

  $('#hideDI').click( function () {
    $('#directedIdentifier').hide()
    $('#hideDI').hide()
    $('#showDI').show()
    return false
  })

  $('#showDI').click( function () {
    $('#showDI').hide()
    $('#hideDI').show()
    $('#directedIdentifier').show()
    return false
  })

  function drawProfile( profile ) {
    // console.log( profile )
    var si = profile[ SI_RS ].si
    $('#profileTable').append('<tr><td>Social Insurance Number</td><td>'+si+'</td></tr>')
    $('#directedIdentifier').text( profile[ IX_ID ].di )
    var people =  profile[ PEOPLE_RS ] &&
                  profile[ PEOPLE_RS ].redirects &&
                  profile[ PEOPLE_RS ].redirects[0] &&
                  profile[ profile[ PEOPLE_RS ].redirects[0] ]
    if (people) {
      $.each( people, function ( item, value ) {
        if (item !== 'photo') {
          $('#profileTable').append('<tr><td>' + item + '</td><td>' + value + '</td></tr>')
        } else {
          $('#profileTable').append('<tr><td>' + item + '</td><td><img src="' + value + '"></td></tr>')
        }
      })
      $('#TOS').show()
    } else {
      $('#closeAccount').show()
    }
  }

  function approveTOS( profile ) {
    drawProfile( profile )
    $('#TOS').show()
    $('#cancel').show()
    $('#logout').hide()
  }

  $('#agreeTOS').click( function () {
    $.ajaxSetup(
      { type: 'POST'
      , headers: { "cache-control": "no-cache" }
      } )
    $.post( '/agree/tos', function ( data, status ) {
      window.location = '/'
    })
    return false
  })

  // function that polls to see if we are logged in yet
  function checkQR ( qrSession ) {
    $.post( '/check/QR', { qrSession: qrSession }, function ( data, status ) {
      if ( status == 'success' && data) {
        if ( data.status == 'waiting')
          return setTimeout( checkQR, 500, qrSession )
        // if (data.error) console.log( data.error )
        if (data.result) {
          $('#qrcodeForm').hide()
          $('#login').hide()
          $('#newAccount').hide()
          $('#introduction').hide()
          $('#backdoor').hide()
          if (data.result[PEOPLE_RS])
            approveTOS( data.result )
          else
            drawProfile( data.result )
        }
        if (data.error && data.error.code && data.error.code === 'UNKNOWN_USER') {
          // $('#errorMessage').text('No records found').css('color','red')
          // $('#error').show()
          window.location('/error')
        }
      }
    })
  }

  $('#login').click( function () {
    $('#error').hide()
    if (agentDirect) {
      window.location = '/login/direct'
    } else {  // put up QR code
      $.get( '/login/QR', function ( data, status ) {
        if (status == "success" && !data.error && data.result && data.result.qrURL ) {
          $('#qrcode').empty()
          $('#qrcodeForm').fadeIn('fast')
          $('#qrcode').qrcode( {width: 400, height: 400, text: data.result.qrURL } )
          setTimeout( checkQR, 500, data.result.qrSession )
        }
      })
    }
    return false
  })

  $('#newAccount').click( function () {
    $('#error').hide()
    if (agentDirect) {
      window.location = '/new/direct'
    } else {  // put up QR code
      $.get( '/new/QR', function ( data, status ) {
        if (status == "success" && !data.error && data.result && data.result.qrURL && data.result.qrSession ) {
          $('#qrcode').empty()
          $('#qrcodeForm').fadeIn('fast')
          $('#qrcode').qrcode( {width: 400, height: 400, text: data.result.qrURL } )
          setTimeout( checkQR, 500, data.result.qrSession )
        }
      })
    }
    return false
  })

  // see if we have a profile to show on a reload
  $.get( '/profile', function ( data, status ) {
    // console.log( '/profile ->', data )
    if (status == "success" && !data.error && data.result ) {   // TBD, deal with error
      $('#logout').show()
      $('#login').hide()
      $('#newAccount').hide()
      $('#introduction').hide()
      $('#backdoor').hide()
      if (data.result['people.a2p3.net'])
        approveTOS( data.result )
      else
        drawProfile( data.result )
    }
    // else if (data.error && data.error === 'NOT_LOGGED_IN') {
    //   $('#errorMessage').text('No records found').css('color','red')
    //   $('#error').show()
    // }
  })

} // onReady

$(document).ready(onReady)

</script>

</body>
</html>