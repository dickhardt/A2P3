<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>A2P3</title>
<meta name="description" content="A2P3">
<meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1,user-scalable=no">
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="http://code.jquery.com/ui/1.10.0/themes/base/jquery-ui.css">
<script type="text/javascript" src="http://code.jquery.com/jquery-1.9.0.js"></script>
<script type="text/javascript" src="http://code.jquery.com/ui/1.10.0/jquery-ui.js"></script>
<script type="text/javascript" src="/js/jquery.qrcode.min.js"></script>
<script type="text/javascript" src="/js/purl.js"></script>
<script type="text/javascript" src="/js/config.js"></script>

</head>
<body>
  <header class="header">
    <section class="headerContainer">
      <span class="mainTitle">A2P3</span>
      <div class="mainTitleText">Authentication & Authorization
        Privacy Protecting Protocol</div>
    </section>

  </header>

  <section class="mainContent">
    <div class="mainContentWrap">

      <div class="mainContentSubTitle">Personal Agent Enrollment</div>
      <div class="mainContentSubTitleTwo">You will need to have a
        Personal Agent installed on your iOS device.</div>
      <div id="profile" class="mainContentDoubleWrap"
        style="margin-top: 10px;">

        <div>
          <div class="dashboardSection">
            <form class="formIOS" method="get" id="iOSAgents"
              action="/dashboard/agent/basic">
              <div class="categoryTitle">
                <span id="peopleServerLabel">PC Users</span>
              </div>

              <div class="dashboardCategoryTitleDetail">If you are
                currently running on a PC click the button below add an agent.</div>

              <input id="QRinstall" type="submit" value="Add Agent via PC"
                ontouchstart="" class="buttonAddIOS">
            </form>
          </div>
          <div class="dashboardSection">
            <div class="categoryTitle">
              <span id="peopleServerLabel">iOS Users</span>
            </div>
            <div class="dashboardCategoryTitleDetail">If you are
              currently running on an iOS device, click the button below add an
              agent.</div>

            <input type="submit" value="Add Agent via iOS" ontouchstart=""
              class="buttonCreateCLI" id="iOSinstall">
          </div>

        </div>

      </div>
    </div>
  </section>

  <section class="footerContent"></section>

  <!-- Dialogs -->

  <div title="Personal Agent Passcode" id="passcodeForm">
    <div class="dashboardCategoryTitleDetail">Create a passcode and remember it. Reconfirm the passcode when your personal agent prompts you.</div>
    <form id="passcode_form_input">

      <div class="cliDialogStyle">
        <span class="passcodeConfirmLabel"> <label
          for="passcode_input">Passcode</label> <input type="password" pattern="\d*"
          name="passcode" size="4" maxlength="4" value="" id="passcode_input"
          class="textAgentPasscode">
        </span>
      </div>
      <div class="cliDialogStyle">
        <span class="passcodeConfirmLabel"> <label
          for="passcode_input2">Confirm</label> <input type="password" pattern="\d*"
          name="passcode2" size="4" maxlength="4" value=""
          id="passcode_input2" class="textAgentPasscode">
        </span>
      </div>
      <div style="margin-top: 20px"
        class="ui-dialog-buttonpane ui-widget-content ui-helper-clearfix"
        style="width:95%">
        <div class="ui-dialog-buttonset" style="margin-top: 5px">
          <input class="ui-button" id="passcode_cancel" type="button"
            value="Cancel"> <input class="ui-button"
            id="passcode_next" type="button" value="Next">
        </div>
      </div>
    </form>
  </div>

  <div title="Scan the QR Code with your Personal
      Agent"
    id="qrcodeForm">
    <div style="text-align: center;" id="qrcode"></div>
  </div>

  <script>


    function onReady() {
      $('#passcodeForm').hide()
      $('#qrcodeForm').hide()

      var iOSinstall = false

      var SETUP_DASHBOARD = 'http://setup.' + config.baseDomain
      if (config.port && config.port != 80)
        SETUP_DASHBOARD += ':' + config.port
      SETUP_DASHBOARD += '/dashboard'

      function showPasscodeForm() {
        $('#passcodeForm').dialog();
        $('#passcode_input').val('').focus()
        $('#passcode_input2').val('')
        $('#status').text('Please enter four digits').css('color', 'black')
        $('#passcode_next').attr("disabled", "disabled")
      }

      function comparePasscodes(fromPasscode) {
        var passcode = $('#passcode_input').val()
        var passcode2 = $('#passcode_input2').val()
        if ((passcode.length == passcode2.length) && (passcode.length == 4)) {
          if (passcode == passcode2) {
            $('#status').text('matching passcodes entered')
            $('#passcode_next').removeAttr("disabled").focus()
          } else {
            if (fromPasscode) {
              $('#passcode_input2').val('')
              $('#status').text('please enter four digits').css(
                  'color', 'black')
              $('#passcode_next').attr("disabled", "disabled")
            } else {
              $('#status').text("PASSCODES DON'T MATCH").css('color',
                  'red')
              $('#passcode_next').attr("disabled", "disabled")
            }
          }
        } else {
          $('#status').text('please enter four digits').css('color',
              'black')
          $('#passcode_next').attr("disabled", "disabled")
        }
      }

      $('#QRinstall').click(function() {
        iOSinstall = false
        showPasscodeForm()
        return false
      })

      $('#iOSinstall').click(function() {
        iOSinstall = true
        showPasscodeForm()
        return false
      })

      $('#passcode_cancel').click(function() {
        $('#passcodeForm').dialog("close");
      })

      $('#passcode_input').bind(
          'input',
          function() {
            // strip out non-numeric
            $('#passcode_input').val(
                $('#passcode_input').val().replace(/[^\d]+/g,
                    ''))
            // move focus to next input if done
            if ($('#passcode_input').val().length >= 4) {
              // Safari does not seem to want to execute this focus change, but will do others ... hmmmm
              $('#passcode_input2').focus()
            }
            comparePasscodes(true)
          })

      $('#passcode_input2').bind(
          'input',
          function() {
            // strip out non-numeric
            $('#passcode_input2').val(
                $('#passcode_input2').val().replace(/[^\d]+/g,
                    ''))
            // move focus to next input if done
            if ($('#passcode_input2').val().length >= 4)
              $('#passcode_input').focus()
            comparePasscodes()
          })

      var cycles = 0
      // function that polls to see if we are have completed enrollment
      function checkCode ( code ) {
        $.post( '/register/check/code', { code: code }, function ( data, status ) {
          if ( status == 'success' && data) {
            // go back to Dashboard if not scanned in 3 minutes
            if (cycles++ > (3 * 120))
              return window.location = SETUP_DASHBOARD
            // still waiting for QR code to be scanned
            if ( data.status == 'waiting')
              return setTimeout( function () { checkCode( code ) }, 500)
            // we are logged in, goto Dashboard
            if (data.result) {
              window.location = SETUP_DASHBOARD
            }
          }
        })
      }

      $('#passcode_next').click( function () {
        // get passcode
        var passcode = $('#passcode_input').val()

        $.ajaxSetup(
          { type: 'POST'
          , headers: { "cache-control": "no-cache" }
          } )

        $.post('/register/agent/code'
            ,{'passcode' : passcode }
            ,function ( data, status ) {
              // TBD deal with errors  data.error exists ...
              if (data.error) {
                $('#passcodeForm').fadeOut('fast')
                return
              }
              var qrURL = data.result.qrURL
              // TBD check we really got a URL!!!
              if (iOSinstall) { // launch Personal Agent on iOS device!!! cross your fingers!
                window.location = qrURL
              } else {
                $('#passcodeForm').dialog("close");

                /// TBD - adjust size of popup and QR code to screen
                // $('#qrcodeForm').fadeIn('fast')
                $('#qrcodeForm').dialog({
                  width : 415,
                  height : 370
                });
                $('#qrcode').qrcode({
                  width : 300,
                  height : 300,
                  text : qrURL
                })
                setTimeout( function () { checkCode( data.result.code ) }, 500 )
              }
            })
        return false
      })
    }

    $(document).ready(onReady)
  </script>

</body>
</html>





